#!/usr/bin/bash
# /etc/X11/xinit/xinitrc, jpf@centauri (c) 2019-2025

# ------------------------------------------------------------------------------
# This script is run via xinit when XOrg gets started explicitly. For example:
#
# login - bash - .bashrc - /etc/bash.centauri - centaurisession - centauridisplay
#
# Display managers usually do not use this file.  What this file does...
#
#   (1) check for .centauristartup to run appliance guis
#   (2) start kde-plasma if installed
#   (3) start lxqt if installed
#   (4) start x-window-manager
#   (5) last resort: run xsession
# ------------------------------------------------------------------------------

# the default window manager
CEN_WM='/usr/bin/x-window-manager'

# wait until WM is up and run payload
run_wmctrl() {
    # run WM in background
    $CEN_WM &
    
    # load resolution dependend autogenerated X resources
    [ -r '/etc/bash.local' ] && . '/etc/bash.local'
    [ -r '/etc/X11/Xresources/centauridisplay' ] && xrdb '/etc/X11/Xresources/centauridisplay'

    # wait until wm is ready ...
    sleep 0.4             
    if ! wmctrl -s0 ; then
        sleep 0.8
        wmctrl -s0 || sleep 1
    fi >/dev/null 2>&1
    [ $# -gt 0 ] && exec "$@"
}

# handle raspi dsi display rotation
if [ -r '/var/centauri/persistent/xinit-rotate' ] ; then
    source '/var/centauri/persistent/xinit-rotate'
    [ -n "$ROTATE_ID" ] && xinput set-prop "$ROTATE_ID" \
        'Coordinate Transformation Matrix' -1 0 1   0 -1 1  0 0 1
fi

# centaurilogin fall-back, appliances should provide custom ~/.xinitrc files  
if [ -x .centauristartup ] ; then
    if [ -x "$CEN_WM" ] ; then
        [ "$CEN_WM" -ef '/usr/bin/xfwm4' ] && CEN_WM+=' --sm-client-disable' 
        run_wmctrl ./.centauristartup
    else
        xmessage "Please install a x-window-manager like 'twm' or 'xfwm4'"
    fi

# start a desktop
elif [ -x /usr/bin/startplasma-x11 ] ; then
    #export XDG_CURRENT_DESKTOP="KDE"
    startplasma-x11
    pkill -g 0 plasma_session
elif [ -x /usr/bin/startlxqt ] ; then
    export XDG_CURRENT_DESKTOP="LXQt"
    startlxqt
elif [ -x /usr/bin/startkde ] ; then
    export XDG_CURRENT_DESKTOP="KDE"
    startkde
elif [ -x "$CEN_WM" ] ; then
    run_wmctrl xterm -fullscreen -sb -rightbar -ls 
else
    . /etc/X11/Xsession
fi

# End

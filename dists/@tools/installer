#!/usr/bin/bash
# ------------------------------------------------------------------------------
# Tool to manage seed and distributable tars
# ------------------------------------------------------------------------------

: ${DAT_SELF:=${0##*/}}             # the name of this script
: ${DAT_SEED:='seed.tgz'}           # seed tar default
                                    # set default for uninitialized (dummy) root
[ "${CEN_ROOT:-.}" = '.' ] && CEN_ROOT='/var/centauri'
CEN_VERB=1

INSTALLER_MARKER=                   # flag for centaurisoho installation
INSTALLER_STATUS=0

INSTALLER_DISTRO=                   # see installer_config()
INSTALLER_CONFIG=                   # ...
INSTALLER_SEED=                     # ...
INSTALLER_COUNTRY=                  # see installer_country()

# persistent data for centauri
INSTALLER_PERSIST='/var/lib/centauri'
# file to remember installation folder, distribution and config
INSTALLER_PERBASE="$CEN_ROOT/default/centaurisoho"
# flag file to override installation protection
INSTALLER_PERCONF="$CEN_ROOT/persistent/centaurisoho-conf"

# change to the installation folder if not run as './<name>"'
[ "$BASH_SOURCE" != "./$DAT_SELF" ] && { cd -- "${BASH_SOURCE%/*}" || exit 1 ; }

# ------------------------------------------------------------------------------
# check if installation is allowed: <what>
# ------------------------------------------------------------------------------
installer_allow() {
    [ -n "$CEN_OPT_FORCE" ] && return
    [ -e "$CEN_ROOT" ] || return
    [ -e "$INSTALLER_PERCONF" ] && return
    message    "I am not daring to" "$1" "on this system. To allow"
    message -i "an installation run:" "touch $INSTALLER_PERCONF"
    quit
}

# ------------------------------------------------------------------------------
# create an archive tar: [<suff>]
#
# An archive tar ('centaurisoho-master.tgz' or 'centaurisoho-master-<suff>.tgz')
# contains all workspace data. It is created from a 'centaurisoho-master' folder
# using 'centaurisoho workspace ...' and cannot be used as a distributable tar.
# ------------------------------------------------------------------------------
installer_archive() {
    installer_chkroot
    local name='centaurisoho-master'
    local orig="${PWD%/*}/$name"
    local file="$name.tgz" ; [ "${1:--}" = '-' ] || file="$name-$1.tgz"
    [ "${PWD##*/}" = "$name" ] ||
        quit -e "Only the '$name' workspace can be archived"

    folder -c '..' || return
    if [ -s "$file" ] ; then
        confirm -y -a "Replace existing archive" "'$file'" || quit -s 2
        system mv -f "$file" "$file.old" || quit
    fi

    orig="${orig#$PWD/}"
    system tar -caf "$file" "$orig" || quit
    message "Created archive:" "$file"
}

# ------------------------------------------------------------------------------
# check root permission, create persistent folder
# ------------------------------------------------------------------------------
installer_chkroot() {
    [ "$EUID" = 0 ] || quit -e "You must be root to run this program"
}

# ------------------------------------------------------------------------------
# get configuration: [-i|-n|-r|-w] [<dist>|- [<conf>|-]]
#
# if <conf>/<dist> are not specified, try to get them from 'seed.tgz' real path
#
# Option -i     no seed check
#        -n     no seed check, no links
#        -r     seed file must be present
#        -w     seed file is optional
# ------------------------------------------------------------------------------
installer_config() {
    if [ "$2$3" = '--' ] ; then
        [ -s "$DAT_SEED" ] || quit -e "No seed file, please specify: <dist> <conf>"
        local path=$(realpath $DAT_SEED)
        path="${path##*/seed-}" ; path="${path%.*}" ; set -- "$1" ${path/-/ }
    fi

    case "$#:$2:$3" in
    3:[!-]*:[!-]*)  ;;
    2:[!-]*)        ;;
    2:*)            quit -e "Unknown distribution, please specify: <dist>" ;;
    *)              quit -e "Unknown config, please specify: <dist> <conf>" ;;
    esac

    INSTALLER_DISTRO="$2"
    INSTALLER_CONFIG="$3"
    INSTALLER_SEED="${DAT_SEED/./-$INSTALLER_DISTRO-$INSTALLER_CONFIG.}"
    INSTALLER_SEED="${INSTALLER_SEED/-.tgz/.tgz}"

    local dist="dists/$INSTALLER_DISTRO"
    local seed="$dist/@seed"
    local star="$seed/$INSTALLER_SEED"

    case "$1" in
    -i) [ -s "$star" ] || warning "Missing seed data:" "$star"
        ;;
    -n) return ;;
    -r) [ -s "$star" ] || quit -e "Missing seed data:" "$star"
        ;;
    -w) if [ ! -d "$seed" ] ; then
            message "Creating seed folder:" "$seed"
            folder -m "$seed" || quit
        fi
        if [ -s "$star" ] ; then
            :
        elif [ ! -d "$dist/dynamic" ] || [ ! -d "$dist/static" ] ; then
            quit -e "Cannot create seed tar without 'dynamic' and 'static' folders"
        fi
        ;;
    *)  quit -e "installer_config: bad call arg:" "$1"
    esac

    [ -z "$INSTALLER_CONFIG" ] && return
    installer_mklinks || quit -e "Failed to activate configuration"
}

# ------------------------------------------------------------------------------
# get 2-letter country code from timezone
# ------------------------------------------------------------------------------
installer_country() {
    resolve -l '/etc/localtime' || return 1
    # it is ok to use a local zone.tab file
    local ftab='/usr/share/zoneinfo/zone.tab'
    [ -r "$ftab" ] || return 1

    local line zone="${CEN_RESOLVE##*zoneinfo/}"
    txtgrep -s line -m -y "[A-Z][A-Z]*[[:space:]]$zone*" -i - <"$ftab"
    [ -z "$line" ] && return 1
    INSTALLER_COUNTRY="${line::2}"
    return 0
}

# ------------------------------------------------------------------------------
# pack the distribution tar: [<dist> <conf>]
# ------------------------------------------------------------------------------
installer_dist() {
    installer_chkroot
    local star dist orig="${PWD##*/}"
    installer_config -w "$@"

    dist="${PWD%/*}/centaurisoho-${INSTALLER_SEED#*-}"
    local star="dists/$INSTALLER_DISTRO/@seed/$INSTALLER_SEED"
    trace -a -c -- 'dist tar' "$dist"
    trace -a -c -- 'seed tar' "$star"

    cd .. || quit -e "Command 'cd ..' failed"
    if [ -e "$dist" ] ; then
        confirm -y -a "Replace existing distributable tar" || quit -s 2
        system mv -f "$dist" "$dist.old" || quit
    fi

    [ -n "$star" ] && symlink -n -- "$star" "$orig/$DAT_SEED"

    local xfrm="centaurisoho-${INSTALLER_SEED#*-}" ; xfrm="s|^$orig/|${xfrm%.*}/|"
    local ddir="$orig/dists/$INSTALLER_DISTRO"
    system tar -caf "$dist" --transform "$xfrm" "$orig/$DAT_SEED" "$orig/$star" \
        "$orig/installer" "$orig/docviewer" \
        "$orig/README-first" "$orig/README"/[0-9]* "$orig/README"/docviewer.* \
        "$orig/dists/@tools" "$ddir/@misc" \
        "$ddir/configs/@shared" "$ddir/configs/$INSTALLER_CONFIG" || quit

    message -i "Created distributable:" "$dist"
}

# ------------------------------------------------------------------------------
# Check interface name: <vnam> <ifce>
# ------------------------------------------------------------------------------
installer_ifname() {
    local name ifce="$2" pref="$CEN_NAME:"
    while [ ! -e "/sys/class/net/$ifce" ] ; do
        read -p "$pref No '$ifce' interface, optionally enter another name: " name
        [ -z "$name" ] && break
        ifce="${name#*/}" ; pref="${pref//?/ }"
    done
    printf -v "$1" '%s' "$ifce"
}

# ------------------------------------------------------------------------------
# prepare the bootimage: [-n|-p]
#
#   Option:     -n      don't update initramfs
#               -p      called from prepare (no motd)
# ------------------------------------------------------------------------------
installer_initial() {
    [ -e '/etc/network/interfaces.installer' ] &&
        system mv -f '/etc/network/interfaces.installer' '/etc/network/interfaces'

    local fini
#    if [ ! -e '/etc/systemd/network/99-default.link' ] ; then
#        message -i "Disable systemd interface naming (rebuilding initrd)"
#        symlink -n '/dev/null' '/etc/systemd/network/99-default.link'
#        fini=1
    if [ '.timestamp' -nt "/boot/initrd.img-$(uname -r)" ] ; then
        [ "$1" = '-n' ] || fini=1
    fi
    if [ -n "$fini" ] ; then
        system -e -p -r -s fini -- uname --kernel-release || return
        fini="/boot/initrd.img-$fini"
        message -a "Updating initrd:" "$fini" "(this needs > 500MB in /run/user/0)"
            # apt may run update-initrd which needs a lot of temp storage...
        [ -d '/run/user/0' ] &&
            system -e -p -- mount -o remount,size=1G,noatime /run/user/0
        system -e -p mkinitramfs -o "$fini"
    fi

    remove /var/lib/dhcp/*leases
    # the debian installer flagged them as 'automatically'
    system -q apt-mark manual bluetooth wpasupplicant iw libdaemon0
    # the debian installer installed these ...
    [ -e '/usr/sbin/powertop' ] && system apt remove wireless-tools powertop libiw30

    [ "$1" = '-p' ] && return 0
    cat - >/etc/motd <<!EOF

This is a minimal unmodified Debian ${INSTALLER_DISTRO^} system (last update: $(date +%Y-%m-%d)).

(1) To install a centaurisoho configuration use:

    $PWD/installer

(2) Alternatively to prepare an installation image use:

    $PWD/installer prepare

(3) Unpack workspace and install centauri-tools only:

    $PWD/installer install

!EOF
}

# ------------------------------------------------------------------------------
# install the seed tar: [<dist> <conf>]
# ------------------------------------------------------------------------------
installer_install() {
    installer_chkroot
    installer_config -r "$@"
    trace -a -c 'install' "$INSTALLER_SEED"

    # protect a system that is not installed via centaurisoho
    installer_allow "install 'centaurisoho'"

    local ddir='/' conf="$INSTALLER_DISTRO-$INSTALLER_CONFIG"

    if [ ! -e '.timestamp' ] ; then
        printf -v mesg "Unpack and install configuration '%s' now" "$conf"
        message "We are about to install 'centaurisoho' on this system"
    elif [ "$DAT_SEED" -nt '.timestamp' ] ; then
        printf -v mesg "Unpack and update configuration '%s' now" "$conf"
        message "We are about to update 'centaurisoho' on this system"
        ddir="/dev/shm/$CEN_NAME"
    elif [ -z "$CEN_OPT_FORCE" ] ; then
        message -i "The '$DAT_SEED' file is already installed" ; return
    else
        printf -v mesg "Unpack and replace configuration '%s' now" "$conf"
    fi

    if confirm -y -i "$mesg" ; then
        # to protect the development system ...
        [ -e '/admin/utilities' ] &&
            quit -e "Cannot install 'centaurisoho' on this system:" '/admin/utilities'
        if [ "$ddir" = '/' ] ; then
            system tar --directory=/ --strip-components=1 -xaf "$DAT_SEED" || quit -s 2
            installer_initial -n
        else
            folder -m "$ddir" || quit -s 2
            # unfortunately --exclude=static cannot be used with --strip-components
            system tar --directory="$ddir" --exclude='static' -xaf "$DAT_SEED" || quit -s 2
            system cp -a "$ddir/dynamic"/* /
        fi
        system touch '.timestamp' || quit -s 2
    else
        quit -s 3
    fi

    # create _centauri_bash_dyn (for autoload and bash builtins)
    system /var/centauri/library/autoload --builtins --quiet

    # create persistent data folder
    if [ ! -d "${INSTALLER_PERCONF%/*}" ] ; then
        folder -m "$INSTALLER_PERSIST" || quit -s 2
        symlink -n "$INSTALLER_PERSIST" "${INSTALLER_PERCONF%/*}" || quit -s 2
    fi
    system echo "$conf" >"$INSTALLER_PERCONF" || quit -s 2

    # save information for centaurisoho (full install only)
    if [ "$ddir" = '/' ] ; then
        conf="SOHO_WORKSPACE=${PWD@Q}\n"
        conf+="SOHO_DISTRO=${INSTALLER_DISTRO@Q}\n"
        conf+="SOHO_CONFIG=${INSTALLER_CONFIG@Q}"
        system echo -e "$conf" >"$INSTALLER_PERBASE" || quit -s 2
        message -i "centauri-tools installation succeeded"
    else
        remove -d "$ddir"
        message -i "centauri-tools update succeeded"
    fi
}

# ------------------------------------------------------------------------------
# show keyboard dialog at next boot: [<host>]
# ------------------------------------------------------------------------------
installer_keyboard() {
    local name="$1" ; [ "$name" = '-' ] && name="$HOSTNAME"
    installer_chkroot
    installer_config -n - -
    if [ -d '/boot/firmware' ] ; then
        local cmdl="root=LABEL=${name}_root rootfstype=ext4 fsck.repair=yes rootwait"
        cmdl+=' console=serial0,115200 console=tty1'
        cmdl+=' centauriswitch=smart systemd.unit=runlevel3.target systemd.show_status=1 quiet'
        create -t -v cmdl '/boot/firmware/cmdline-default.txt'
        cmdl+=' centaurilogin=root'
        create -t -v cmdl '/boot/firmware/cmdline.txt'
        copy -a '/boot/firmware/config.txt' '/boot/firmware/config-default.txt'
        create -t -v name '/etc/hostname'
    elif [ -d '/boot/grub' ] ; then         # modify grub.cfg, rename host
        copy -a 'templates/@shared/a_boot_grub+grub.cfg.TEMPLATE' \
                '/boot/grub/grub.cfg' || return
        system sed -e "s/^set myname=.*/set myname=$name/" \
                -e "s/set distro=.*/set distro=$INSTALLER_DISTRO/" \
                -i '/boot/grub/grub.cfg' || return
        copy -a '/boot/grub/grub.cfg' '/boot/grub/grub.cfg.orig'
        system sed -e 's/^set params="mitigations/set params="centaurilogin=root mitigations/' \
                -i '/boot/grub/grub.cfg' || return
        embed centauridivert update update-grub -- update dhclient
        [ "$HOSTNAME" != "$name" ] && embed centaurirestore -y -R / -C "$name"
    else
        return
    fi

    message "At next boot a keyboard configuration dialog will be shown"
    centaurisysinit issue add "$PWD/$CEN_NAME" login
    symlink "$CEN_TOOLS/centaurisysinit" '/root/.autologin'
}

# ------------------------------------------------------------------------------
# udate symlinks in workspace
# ------------------------------------------------------------------------------
installer_links() {
    installer_chkroot
    installer_config -i "$@"
}

# ------------------------------------------------------------------------------
# First boot after prep: reconfigure keyboard              (works for grub only)
# ------------------------------------------------------------------------------
installer_login() {
    # undo boot settings ...
    [ -e '/boot/firmware/cmdline-default.txt' ] &&
        system cp -a '/boot/firmware/cmdline-default.txt' '/boot/firmware/cmdline.txt'
    [ -e '/boot/grub/grub.cfg.orig' ] &&
        system mv -f '/boot/grub/grub.cfg.orig' '/boot/grub/grub.cfg'
    remove /root/.autologin

    # payload ...
    system dpkg-reconfigure keyboard-configuration
}

# ------------------------------------------------------------------------------
# reduce dist usage
# ------------------------------------------------------------------------------
installer_minimal() {
    [ -e '.timestamp' ] && quit -e "Cannot run 'minimal' after 'install'"
    installer_initial
    confirm -y "Minimize disk usage and zero-fill" || return

    local item curr="$PWD"
    if folder -c /var/log ; then
        system -q systemctl stop systemd-journald
        remove -d installer journal/* apt/*
        remove -- *.gz */*.gz *.[0-9] */*.[0-9]
        for item in *.log ; do                  # zero-size log files
            [ -s "$item" ] || continue
            > "$item"
        done
    fi
    folder -c "$curr"

    message -i "Zerofill file system ..."
    system -q -- dd if=/dev/zero of=zero.tmp bs=1M
    system sync ; remove zero.tmp

    message -i "Clean swap space ..."
    system swapoff -a
    system swapon -a -donce
    message -i "Done."
}

# ------------------------------------------------------------------------------
# udate symlinks from configs/<dist>/<inst>
# ------------------------------------------------------------------------------
installer_mklinks() {
    local link item ferr=0 base="dists/$INSTALLER_DISTRO/configs"

    for link in 'configs' 'dynamic' 'static' ; do
        [ -e "dists/$INSTALLER_DISTRO/$link" ] || continue
        symlink -n "dists/$INSTALLER_DISTRO/$link" "$link" || ferr=1
    done

    for item in 'packages' 'private' 'templates' 'passwords' 'setup.conf' ; do
        if [ -e "$base/$INSTALLER_CONFIG/$item" ] ; then
            link="$base/$INSTALLER_CONFIG/$item"
        elif [ -e "$base/@shared/$item" ] ; then
            link="$base/@shared/$item"
        else
            error -a "Missing component:" "$base/.../$item"
            ferr=1 ; continue
        fi
        symlink -n "$link" "$item" || ferr=1
    done

    for item in 'imagetool' 'installer' 'setup' ; do
        symlink -n "dists/@tools/$item"
    done

    item="dists/$INSTALLER_DISTRO/@seed/$INSTALLER_SEED"
    if [ -s "$item" ] ; then
        symlink -n "$item" "$DAT_SEED" || ferr=1
    else
        remove -- "$DAT_SEED"
    fi
    return $ferr
}

# ------------------------------------------------------------------------------
# pack the seed tar: [<dist> <conf>]
# ------------------------------------------------------------------------------
installer_pack() {
    installer_config -w "$@"
    local file stat dyna conf
    stat="dists/$INSTALLER_DISTRO/static/var/centauri/configs/$INSTALLER_DISTRO"
    dyna="dists/$INSTALLER_DISTRO/dynamic/var/centauri/configs/$INSTALLER_DISTRO"
    conf="$dyna/$INSTALLER_CONFIG"

    [ -d "$stat" ] || quit -e "Missing data:" "$stat"
    [ -d "$conf" ] || quit -e "Missing data:" "$conf"

    local excl=() incl=('dynamic' 'static')
    if [ -n "$INSTALLER_CONFIG" ] ; then
        for item in "$stat"/* "$dyna"/* ; do
            case "${item##*/}" in
            $INSTALLER_CONFIG) ;;
            @*)     ;;
            *)      item="${item#*/*/}"
                    trace -a -c 'exclude' "$item"
                    excl+=('--exclude' "$item")
            esac
        done
    else
        incl+=('configs')
    fi
    file="dists/$INSTALLER_DISTRO/@seed/$INSTALLER_SEED"

    if [ -e "$file" ] ; then
        if confirm -y -a "Replace existing '$file'" ; then
            remove "$file" || quit
        else
            quit -s 2
        fi
    fi

    system tar -caf "$file" --dir dists/$INSTALLER_DISTRO "${excl[@]}" "${incl[@]}" || quit
    message -a "Created seed tar:" "$file"
    [ -n "$INSTALLER_CONFIG" ] && installer_mklinks
}

# ------------------------------------------------------------------------------
# Set password from password file: <user> <file>
# ------------------------------------------------------------------------------
installer_password() {
    local rpwd
    txtgrep -s rpwd -y "$1=*" -i - <"$2"
    rpwd="${rpwd#*=}" ; trimjoin -s rpwd
    if [ -z "$rpwd" ] ; then
        error "No password found for user:" "$1" ; return
    elif [ "$rpwd" = '-' ] ; then
        return
    fi
    system -q pwauth <<!EOF && return
$1
$rpwd
!EOF
    confirm -a -n "Set password for user '$1'" || return
    system -e -p chpasswd <<!EOF
$1:$rpwd
!EOF
}

# ------------------------------------------------------------------------------
# Prepare system before centaurisoho setup: [-f] [<name>]
#
# This code works on a 'best effort' base and does limited error checking only!
# ------------------------------------------------------------------------------
installer_prepare() {
    installer_chkroot

    # we need centauri-bash-lib ...
    if [ -n "$CEN_OPT_FORCE" ] ; then           # see 'exec ... -f ...' below
        [ -z "$CEN_HOOK_MAIN" ] &&              # no full centauri-bash-lib
            quit "Please run '$CEN_NAME install' and try again"
    elif [ -z "$CEN_HOOK_MAIN" ] ; then
        installer_install - -
        exec "./$CEN_NAME" -f prepare           # re-run to load centauri-bash-lib
    fi

    installer_allow "run  action 'prepare'"
    if [ -z "$CEN_OPT_FORCE" ] ; then
        confirm -n "BEWARE: run 'prepare' only if you really know want you are doing" ||
            quit "Terminated"
    else
        confirm -y "Prepare this system for centauri-soho" || return
    fi

    # read super config
    if [ -s 'setup.conf' ] ; then
        source 'setup.conf'
    else
        quit "Missing 'setup.conf'"
    fi
    local name="${SOHO_SONAME}8"
    case "${1:--}" in
    -)  name="${SOHO_SONAME}8" ;;
    ?)  name="${SOHO_SONAME}$1" ;;
    *)  name="$1"
    esac

    # --- update system ---

    message "Updating installed packages..."
    embed centauripackage -U2 -G -s || return
    embed centauripackage -T -I -s -y isc-dhcp-client dosfstools || return
    system -q apt-mark manual wpasupplicant iw libdaemon0
    embed centaurisoho message step0 '/etc/motd' '' $(date --iso-8601) || return
    message -i

    # --- set locales, install localepurge ---

    if confirm -n "Reconfigure locale settings" ; then
        system dpkg-reconfigure locales
        system dpkg-reconfigure tzdata
        system dpkg-reconfigure keyboard-configuration
    fi
    message -i

    if [ -e '/etc/locale.nopurge.off' ] ; then
        :                                       # did run before
    elif confirm -y "Install localepurge (remove unused locales)" ; then
        [ -e '/etc/locale.nopurge' ] &&
            quit "Try to run 'apt purge localepurge' before this!"
        embed centauripackage -T -s -y localepurge pwauth
        message -i
        if confirm -y "Run localepurge now" ; then
            copy -a '/etc/locale.nopurge' '/etc/locale.nopurge.off'
            system sed -e 's/^USE_DPKG/#USE_DPKG/' -i '/etc/locale.nopurge'
            system localepurge
            remove '/etc/locale.nopurge'
        else
            move -q '/etc/locale.nopurge' '/etc/locale.nopurge.off'
        fi
    fi
    message -i

    # --- renaming and fstab ---

    local vnam ddev
    if [ -b '/dev/disk/by-label/rootfs' ] && confirm -n "Rename system as '$name'" ; then
        message -i "Rename RaspberryPi disk partions..."
        vfatname vnam "$name"                       # random prefix for long name
        resolve -c -s ddev '/dev/disk/by-label/rootfs'
        case "$ddev" in
        /dev/sd*)       ddev="${ddev%[0-9]}" ;;
        /dev/*p[0-9])   ddev="${ddev%p[0-9]}" ;;
        *)              error "Unknown boot device type, cannot rename:" "$ddev" ; ddev=
        esac
        if [ -n "$ddev" ] ; then
            embed -i centaurimedia --yes --device="$ddev" label 1 "${vnam}_boot" || return
            embed -i centaurimedia --yes --device="$ddev" label 2 "${name}_root" || return
            create -t -c '/etc/fstab' <<!EOF
LABEL=${vnam}_boot  /boot/firmware  auto  rw,defaults,noatime 0 0
LABEL=${name}_root  /               auto  rw,defaults,noatime 0 0
!EOF
        fi
    # debian image (bookworm has sda5) ...
    elif [ -b '/dev/sda3' -o -b '/dev/sda5' ] && confirm -y "Rename system as '$name'" ; then
        message "Rename x86 disk partions..."
        if [ -b '/dev/sda5' ] ; then
            embed -i centaurimedia --yes --device='/dev/sda' label 1 "${name}_root" || return
            embed -i centaurimedia --yes --device='/dev/sda' label 5 "${name}_swap" || return
            create -t -c '/etc/fstab' <<!EOF
LABEL=${name}_root    /       auto  rw,defaults,noatime 0 0
LABEL=${name}_swap    none    swap
!EOF
        else
            embed -i centaurimedia --yes --device='/dev/sda' label 1 "${name}_boot" || return
            embed -i centaurimedia --yes --device='/dev/sda' label 2 "${name}_root" || return
            embed -i centaurimedia --yes --device='/dev/sda' label 3 "${name}_swap" || return
            create -t -c '/etc/fstab' <<!EOF
LABEL=${name}_root  /           auto  rw,defaults,noatime 0 0
LABEL=${name}_boot  /boot/efi   vfat  rw,defaults,noatime 0 0
LABEL=${name}_swap  none        swap
!EOF
        fi
    fi

    # --- set root/local passwords ---

    local pwds='passwords'
    if [ -r "$pwds" ] ; then
        message "Checking passwords..."
        system -c pwauth || embed centauripackage -T -s -y pwauth
        installer_password 'root'  "$pwds"
        installer_password 'local' "$pwds"
    else
        error "Cannot read password file:" "$PWD/$pwds"
    fi

    # --- network configuration ---

    if confirm -y "Configure network settings" ; then
        system -q ifdown -a                     # go down as we will reconfigure...
        message -a "Network is offline now"
        system -e -p systemctl disable wpa_supplicant.service
        system -q    systemctl disable NetworkManager.service ModemManager.service
        message -a "Disabled NetworkManager/ModemManager and wpa_supplicant services"

        local ieth iwla
        installer_ifname ieth 'eth0'
        installer_ifname iwla 'wlan0'
        create -t -c '/etc/network/interfaces.installer' <<!EOF
# bootstrap interface config only - this file intends to start networking
# in background to avoid a system that hangs at boot time. NetworkManager
# handles this correctly, but at this point we want to use a classic setup.

# Please add WLAN credentials to /etc/wpa_supplicant/wpa_supplicant.conf, see
#   centaurinetgen wpa - <password>

auto lo
iface lo inet loopback

iface $ieth inet manual
pre-up   /usr/sbin/dhclient -nw -4 -v -i -pf /run/dhclient.$ieth.pid -lf /var/lib/dhcp/dhclient.$ieth.leases -I -df /var/lib/dhcp/dhclient6.$ieth.leases $ieth
pre-down /usr/sbin/dhclient  -r -4 -v -i -pf /run/dhclient.$ieth.pid -lf /var/lib/dhcp/dhclient.$ieth.leases -I -df /var/lib/dhcp/dhclient6.$ieth.leases $ieth
auto $ieth

iface $iwla inet manual
wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf
pre-up   /usr/sbin/dhclient -nw -4 -v -i -pf /run/dhclient.$iwla.pid -lf /var/lib/dhcp/dhclient.$iwla.leases -I -df /var/lib/dhcp/dhclient6.$iwla.leases $iwla
pre-down /usr/sbin/dhclient  -r -4 -v -i -pf /run/dhclient.$iwla.pid -lf /var/lib/dhcp/dhclient.$iwla.leases -I -df /var/lib/dhcp/dhclient6.$iwla.leases $iwla
auto $iwla
!EOF
        local wpsk
        txtgrep -s wpsk -y wlanpsk=\* -i - <passwords
        wpsk="${wpsk#*=}"
        installer_country                       # get country code
        create -t -c '/etc/wpa_supplicant/wpa_supplicant.conf' <<!EOF
# This intermedeate file will be replaced later during the installation process

ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev

# For RaspberryPi we need to set a country code (not using NetworkManager)
country=${INSTALLER_COUNTRY:-DE}

network={
    ssid="$SOHO_NET_WLAN"
    scan_ssid=1
    key_mgmt=WPA-PSK
    psk="${wpsk:-your-password}"
}
!EOF
        [ -z "$wpsk" ] &&
            message "Add password to '/etc/wpa_supplicant/wpa_supplicant.conf' manually"
    fi

    if [ -e '/etc/systemd/network/99-default.link' ] ; then
        if [ "$ieth" != 'eth0' ] ; then
            remove '/etc/systemd/network/99-default.link'
            system -e touch '.timestamp'
        fi
    else
        if [ "$ieth" = 'eth0' ] ; then
            symlink -n '/dev/null' '/etc/systemd/network/99-default.link'
            system -e touch '.timestamp'
        fi
    fi
    installer_initial
    embed centaurisoho message step1 /etc/motd

    message -i
    local mesg='systemd'
    [ -e '/etc/systemd/network/99-default.link' ] && mesg='bios'
    message "Next boot may use $mesg interface names, please check '/etc/network/interfaces'"
    message -i

    # --- fix cmdline/grub ---

    installer_keyboard "$name"              # does not handle systemd-boot
    message -i

    # --- remove all cached stuff ---

    if confirm -y "Clean-up disk space" ; then
        system systemctl --quiet stop systemd-journald
        system centauricleanup -y -A
    fi
    message -i

    message -i
    message "System prepare succeeded"
}

# ------------------------------------------------------------------------------
# try to remove centauri things: -no args-
# ------------------------------------------------------------------------------
installer_remove() {
    installer_chkroot
    confirm -y "Remove centauritools/library and configuration" || quit -s 2

    # to protect the development system ...
    [ -e '/admin/utilities' ] && quit -e "Cannot remove 'centaurisoho' from this system"

    local item subi subd base="$PWD" ; cd ..
    remove    /usr/local/bin/centauri* /usr/local/bin/_centauri_bash_lib
    remove -d /var/centauri /etc/default/centauri* /var/lib/centauri
    remove -d /run/centauri /centauritools /etc/centauri* "$base"

    # remove stale service links
    for item in /etc/systemd/system/* ; do
        if [ -d "$item" ] ; then
            subd=
            for subi in "$item"/* ; do
                [ -L "$subi" ] || continue
                [ -e "$subi" ] && continue
                remove "$subi" ; subd=1
            done
            [ -n "$subd" ] || continue
            rmdir "$item" 2>/dev/null
        fi
        [ -L "$item" ] || continue
        [ -e "$item" ] || remove "$item"
    done
}

# ------------------------------------------------------------------------------
# unpack the seed tar: [<dist> <conf>]
# ------------------------------------------------------------------------------
installer_unpack() {
    installer_chkroot
    installer_config -n "$@"
    confirm -y -i "Unpack '$INSTALLER_SEED' into workspace now" || quit -s 2
    local dist="$PWD/dists/$INSTALLER_DISTRO"
    local file="$dist/@seed/$INSTALLER_SEED"
    [ -d "$dist/dynamic" ] && rename "$dist/dynamic" "$dist/dynamic.old" || quit
    [ -d "$dist/static" ] && rename "$dist/static" "$dist/static.old" || quit

    system tar --directory="$dist" -xaf "$file" || quit
    if [ -d "$dist/dynamic" -a "$dist/static" ] ; then
        message "Seed tar unpack succeeded"
        remove -d "$dist/dynamic.old" "$dist/static.old"|| quit
    else
        fatal "Invalid tar, missing 'dynamic' or 'static' folder"
    fi
    [ -z "$INSTALLER_CONFIG" ] && return
    installer_mklinks || quit -e "Failed to activate configuration"
}

# ------------------------------------------------------------------------------
# output help info
# ------------------------------------------------------------------------------
installer_usage() {
    if [ "$1" != '-h' ] ; then
        usagecat <<!EOF
$CEN_NAME: This tool is a helper for 'centaurisoho'. Except for installing the
           '$DAT_SEED' file it usally is not used from command line. See:

           °   Installing and setup:     centaurisoho --help
           °   Details about this tool:  $CEN_NAME --help

           After installing the seed file the centauri tools are available.
           Run the 'centaurisoho' tool to continue the installation.

!EOF
    else
        usagecat <<!EOF

Usage: $CEN_NAME install [<dist> <conf>]   # install '$DAT_SEED' to system
       $CEN_NAME keyboard [<host>]         # keyboard dialog at raspi/grub boot
       $CEN_NAME prepare [<name>]          # pre-configure for centauri-soho
       $CEN_NAME remove                    # try to remove centauri things

       $CEN_NAME archive [<suff>]          # create archive tar from workspace
       $CEN_NAME dist    [<dist> [<conf>]] # create distributable from workspace
       $CEN_NAME links   [<dist> <conf>]   # create symlinks to workspace only
       $CEN_NAME login                     # 1st grub.cfg boot: keyboard config
       $CEN_NAME minimal                   # minimize disk usage
       $CEN_NAME pack    [<dist> [<conf>]] # pack workspace to '$DAT_SEED'
       $CEN_NAME unpack  [<dist> [<conf>]] # unpack '$DAT_SEED' to workspace

       This tool is a bootstrap installer and helper for 'centaurisoho'.

Options:
       -d --dryrun     make no changes, just show commands
       -f --force      override prudent default behaviours
       -h --help       show this text
       -v --verbose    be verbose (use twice for debug)

Arguments:
       <dist>          a distribution name  (like 'bookworm')
       <conf>          a configuration name (like 'worms')

!EOF

if [ -z "$CEN_PAGER" ] ; then
    confirm -y "Continue output..." || quit -s 2
fi
usagecat <<!EOF

Remarks:'$CEN_NAME' is a self-contained bash script that manages two tar archives:

        (1) centaurisoho-<dist>-<conf>.tgz (or centaurisoho-<dist>.tgz) which is
        °   the deployment medium for centaurisoho. It contains seed tar files,
        °   '$CEN_NAME' and other data used for the centaurisoho setup procedure.
        °   The tar file extracts to the centaurisoho base folder that contains
        °   '$CEN_NAME'.

        (2) seed-<dist>-<conf>.tgz  (or seed-<dist>.tgz) which contains the
        °   centauri-bash-library, centauri-tools and the initial repository data.

        All setup data except '$CEN_NAME' can depend on <dist> or even <conf> but
        '$CEN_NAME' does not have such dependencies. The install, dist or unpack
        commands create sym-links to version dependent data.

        The optional prepare command is used to create a distributable disk image.
        It pre-sets (wlan) network, grub-boot, locales and installs locale-purge.

!EOF
    fi
    quit -s 2
}

# ------------------------------------------------------------------------------
# make 6 char (random)name for vfat label: <vnam> <name>
# make 6 char random string not starting with lower case letter
# ------------------------------------------------------------------------------
vfatname() {
    local pref="$2"
    if [ "${#pref}" -gt 6 ] ; then
        while : ; do
            read -r -N 16 pref </dev/urandom || fatal "Cannot read from /dev/urandom"
            system -f -p -r -s pref base64 <<<$pref
            [ "${#pref}" -gt 10 ] && break
        done
        pref="${pref//[\/+]/%}" ; pref="${pref:3:6}"
    fi
    printf -v "$1" '%s' "$pref"
}

# ------------------------------------------------------------------------------
# execute payload
# ------------------------------------------------------------------------------
run() {
    case "${1::3}$#" in
    0)          if [ -x '/usr/local/bin/_centauri_bash_lib' -a -e '.timestamp' ] ; then
                    installer_usage
                else
                    installer_install - -
                    confirm -y "Install centauri seed on this system" &&
                        embed centaurisoho seed
                fi ;;
    arc[12])    installer_archive  "${2:--}" ;;
    dis2)       installer_dist     "${2:--}" ;;
    dis[13])    installer_dist     "${2:--}" "${3:--}" ;;
    ins[123])   installer_install  "${2:--}" "${3:--}" ;;
    key[12])    installer_keyboard "${2:--}" ;;
    lin[123])   installer_links    "${2:--}" "${3:--}" ;;
    log1)       installer_login    ;;
    min1)       installer_minimal  ;;
    pac2)       installer_pack     "${2:--}" ;;
    pac[13])    installer_pack     "${2:--}" "${3:--}" ;;
    pre[12])    installer_prepare  "${2:--}" ;;
    rem1)       installer_remove   ;;
    unp[2])     installer_unpack   "${2:--}" ;;
    unp[13])    installer_unpack   "${2:--}" "${3:--}" ;;
    *)          installer_usage -h
    esac 1>&2
}

# ------------------------------------------------------------------------------
# help display
# ------------------------------------------------------------------------------
usage() {
    installer_usage -h
}

# ------------------------------------------------------------------------------
# This tool can be run without centauri-bash-lib being installed. If so it uses
# a couple of simplified library equivalents that are created below ...
# ------------------------------------------------------------------------------
[ "${CEN_NAME:--}" = '-' ] && [ -x '/usr/local/bin/_centauri_bash_lib' ] &&
    . /usr/local/bin/_centauri_bash_lib -a -d -f - '0.12:2' 0

### mini-bash-lib packed ###
if [ -z "$CEN_HOOK_MESSAGE" ];then
{
{
CEN_STDOUT=41
CEN_STDERR=42
eval exec "$CEN_STDOUT>&1" "$CEN_STDERR>&2"
CEN_EXIT=0
CEN_HOOK_MESSAGE='message'
CEN_HOOK_QUIT=
CEN_IDNT=
CEN_MINI_VERSION='0.05'
: ${CEN_VERSION:=$CEN_MINI_VERSION}
CEN_ARGS=
CEN_ARGOPT=
CEN_ACTARR=
CEN_CONFIRM=
CEN_OPT_DRYRUN=
CEN_OPT_FORCE=
CEN_TMP_BASE="${TMPDIR:-/tmp}/$EPOCHSECONDS-$BASHPID-"
CEN_TMP_INDX=0
CEN_TMP_SYSO=
CEN_TMPFILE=
CEN_VERB=1
CEN_YESNO=
}
warning(){ message -w "$@";}
error(){ message -e -l "$@";return "$CEN_EXIT";}
fatal(){ [ "$1" = '-t' ]&&set -- "${@:2}";message -f -l "$@";quit;}
trace(){ [ "$CEN_VERB" -lt 2 ]&&return 0;message "$@";}
message(){
local _idnt="$CEN_NAME:" _exit _mesg _olog="$CEN_VERB" _opre _oqui _omul _opri
while [ "${1::1}" = - ];do
case "$1" in
-)break;;
--)shift;break;;
-a)[ -n "$CEN_IDNT" ]&&_idnt="${_idnt//?/ }";;
-c)
local _asci _ugly
_asci="${2//[[:alpha:]]/.}"
printf -v _ugly $"%-16s:" "$_asci"
printf -v _opre '%s' "${_ugly/$_asci/$2}"
shift;;
-e)_opre=$"***ERROR***";_exit=2;;
-f)_opre=$"***FATAL ERROR***";_exit=3;;
-i)_idnt="${_idnt//?/ }";;
-l)_olog=1;;
-m)_omul=1;;
-p)_opri=1;;
-q)[ "$CEN_EXIT" = 0 ]&&return 0;_oqui=1;;
-t)[ "$CEN_EXIT" = 0 ];return;;
-w)_opre=$"***WARNING***";;
esac;shift
done
[ -n "$_exit" ]&&{ _olog=1;CEN_EXIT="$_exit";}
[ -n "$_oqui" ]&&quit -e "$@"
[ "$_olog" -lt 1 ]&&return 0
if [ -n "$_omul" ];then
_omul="$1";shift
set -- "$_omul${@/*/$'\n'${_idnt//?/ } &}"
fi
[ -z "$_opri" ]&&_mesg="$*"||printf -v _mesg "$@"
[ -n "$_opre" ]&&_mesg="$_opre $_mesg"
echo "$_idnt" "$_mesg" >&2
CEN_IDNT=1
}
confirm(){
local _ofmt _oupc _what=1 _repl _vnam='CEN_CONFIRM' _idnt="$CEN_NAME:" _info _defn _text
while [ "${1::1}" = - ];do
case "$1" in
--)shift;break;;
-a)[ -n "$CEN_IDNT" ]&&_idnt="${_idnt//?/ }";;
-d)shift;_defn="$1";;
-f)_ofmt=1;;
-i)_idnt="${_idnt//?/ }";;
-n)_what=1;;
-p)shift;_what=;_info="$1";;
-s)shift;_vnam="$1";;
-u)_oupc=1;;
-y)_what=0
esac;shift
done
[ -z "$_ofmt" ]&&_text="$*"||printf -v _text "$@"
if [ -z "$_what" ];then
[ "$_info" = - ]&&_info=': '
read -p -r "$_idnt $_text$_info" _repl;CEN_IDNT=1
[ -z "$_repl" ]&&_repl="$_defn"
[ -z "$_oupc" ]&&_repl="${_repl,,}"
[ -n "$_vnam" ]&&printf -v "$_vnam" '%s' "$_repl"
[ -n "$_repl" ];return
fi
local _locy _locn _loqy _loqn _loca=$"yes°no° [Y/n]? ° [y/N]? "
IFS='°' read -r _locy _locn _loqy _loqn <<<"$_loca"
if [ -z "$CEN_YESNO" ];then
if [ "$_what" = 0 ];then
_defn="$_locy";_info="$_loqy"
else
_defn="$_locn";_info="$_loqn"
fi
while :;do
read -rp "$_idnt $_text$_info" _repl;CEN_IDNT=1
_repl="${_repl,,}"
case "${_repl::1}" in
'')  _repl="$_defn";break;;
"${_locn::1}") _repl="$_locn";break;;
"${_locy::1}") _repl="$_locy";break
esac
message -l $"Please enter 'yes' or 'no'"
done
else
[ "$CEN_YESNO" = 'y' ]&&_repl="$_locy"||_repl="$_locn"
fi
[ -n "$_vnam" ]&&printf -v "$_vnam" '%s' "$_repl"
[ "$_repl" = "$_locy" ]
}
create(){
local _rdry _rtru _vnam _fout _darr
while [ "${1::1}" = - ];do
case "$1" in
--)shift;break;;
-c)_vnam='-';;
-r)_rdry='-r';;
-t)_rtru=1;;
-v)shift;_vnam="$1"
esac;shift
done
[ "${1:--}" = - ]&&_fout='/dev/stdout'||_fout="$1"
if [ -z "$_rtru" ]&&[ "${_fout::5}" != '/dev/' ]&&[ -e "$_fout" ];then
trace -c $"Existing file" "$_fout";return 0
fi
dryrun $_rdry $"Create file" "$@"&&return 1
_cen_create_file "$_fout"||return 1
[ -z "$_vnam" ]&&return 0
if [ "$_vnam" = - ];then
local _darr;readarray -t _darr
else
local -n _darr="$_vnam"
fi
printf '%s\n' "${_darr[@]}" >"$_fout"
}
_cen_create_file(){
true >"$1" 2>/dev/null&&return 0;error $"Failed to create file:" "$1"
}
dryrun(){
local _rdry="$CEN_OPT_DRYRUN"
while [ "${1::1}" = - ];do
case "$1" in
--)shift;break;;
-r)_rdry=;;
esac;shift
done
if [ -z "$_rdry" ];then
trace -a -c $"Execute" "$@";return 1
fi
message -a -c $"Skip" "$@";return 0
}
embed(){
local _stat _opts=()
while [ "${1::1}" = - ];do
case "$1" in
--)shift;break;;
-m)return 0;;
-a|-s)_opts+=("$1" "$2");shift;;
-*)_opts+=("$1")
esac;shift
done
_opts+=('--' "$1" '--embed' "$CEN_NAME");shift
[ -n "$CEN_OPT_DRYRUN" ]&&_opts+=('--dryrun')
system -r "${_opts[@]}" "$@";_stat="$?"
[ "$_stat" = 3 ]&&quit -s 3;return "$_stat"
}
folder(){
local _ochg _omak _oerr='error' _oopt='-e -p'
while [ "${1::1}" = - ];do
case "$1" in
--)shift;break;;
-c)_ochg='cd';;
-f)_oerr='fatal';_oopt='-f -p';;
-m)_omak=1;;
-p)_ochg='cd -P';;
-q)_oerr=':';_oopt='-q';;
esac;shift
done
if [ ! -d "$1" ];then
if [ -n "$_omak" ];then
system $_oopt -- mkdir -p "$1"||return 1
else
$_oerr $"Not a folder:" "$1";return 1
fi
fi
[ -z "$_ochg" ]&&return 0
system -r $_oopt -- eval "$_ochg" "$1"||return 1
trace -a -c $"Current folder" "$PWD";return 0
}
splitjoin(){
local _sopt _deli
while [ "${1::1}" = - ];do
case "$1" in
--)shift;break;;
-d)shift;printf -v _deli "$1";;
-s)shift;local -n _vjsx="$1";_sopt=1;;
-j)shift;local -n _vjsx="$1";_sopt=2;;
esac;shift
done
case "$_sopt" in
1)[ -z "$_deli" ]&&_deli=$'\t\n'
local _sifs="$IFS"
set -f;IFS="$_deli" _vjsx=($*);set +f;IFS="$_sifs";;
2)[ -z "$_deli" ]&&_deli=$'\t'
printf -v _vjsx "${_deli::1}%s" "$@";_vjsx="${_vjsx:1}";;
*)return 1
esac;return 0
}
copy(){ _cen_simple_cmd 'cp' "$@";}
rename(){ _cen_simple_cmd 'mv' "$@";}
remove(){ _cen_simple_cmd 'rm' -F "$@";}
symlink(){ _cen_simple_cmd 'ln' -S "$@";}
_cen_simple_cmd(){
local _oerr='-e -p' _orun _args=("$1");shift
while [ "${1::1}" = - ];do
case "$1${_args::1}" in
--?)shift;break;;
-ac)_args+=('-a');;
-uc)_args+=('-u');;
-dr)_args+=('-r');;
-Fr)_args+=('-f');;
-or)_args+=('--one-file-system');;
-nl)_args+=('-f');;
-rl)_args+=('-r');;
-Sl)_args+=('-s');;
-f?)_oerr='-f -p';;
-q?)_oerr='-q';;
-r?)_orun=1;;
esac;shift
done
system $_oerr $_orun -- "${_args[@]}" "$@"
}
system(){
local _stat _rdry _fchk _olou _onam _ored _otyp _odel _oerr=':' _oqui=':'
while [ "${1::1}" = - ];do
case "$1" in
--)shift;break;;
-a)shift;_onam="$1";_ored=1;_otyp=2;;
-c)_fchk=1;;
-d)shift;_odel="$1";;
-e)_oerr='error';_olou='-l';;
-f)_oerr='message -f -l';_olou='-l';_oqui='quit';;
-p)_ored=1;[ -z "$_otyp" ]&&_otyp=0;;
-q)_ored=0;;
-r)_rdry='-r';;
-s)shift;_onam="$1";_ored=1;_otyp=1;;
-t)[ "$CEN_EXIT" = 0 ]||return 1;;
-w)_oerr='warning';;
-z)_ored=2;[ -z "$_otyp" ]&&_otyp=0;;
esac;shift
done
if [ -n "$_fchk" ];then
_stat=0
for _fchk in "$@";do
type -t "$_fchk" &>/dev/null&&continue
$_oerr -p $"Command '%s' not found" "$_fchk";_stat=127;$_oqui
done
return "$_stat"
fi
dryrun $_rdry "$@"&&return 1
[ -n "$_otyp" -a -z "$CEN_TMP_SYSO" ]&&tmpfile -r -s CEN_TMP_SYSO
case "$_ored" in
0)"$@" &>/dev/null;return;;
1)"$@" &>"$CEN_TMP_SYSO";_stat=$?;;
2)"$@" 2>"$CEN_TMP_SYSO";_stat=$?;;
*)"$@";_stat=$?
esac
[ "$_stat" = 0 -a -z "$_onam" ]&&return 0
[ "$_otyp" = 2 ]&&local -n _vsys="$_onam"||local _vsys
[ -n "$_otyp" ]&&readarray -t _vsys <"$CEN_TMP_SYSO"
[ "$_otyp" = 1 ]&&splitjoin -j "$_onam" -- "${_vsys[@]}"
[ "$_stat" = 0 ]&&return 0
CEN_IDNT=;$_oerr -p $"Running '%s' failed (status %s)" "$1" "$_stat"
[ -n "$_otyp" ]&&message -a -m $_olou -- "${_vsys[@]}"
$_oqui;return "$_stat"
}
tmpfile(){
local _vtmp='CEN_TEMPFILE' _rdry _crea=1
local _temp="$CEN_TMP_BASE$CEN_TMP_INDX-$BASHPID"
((CEN_TMP_INDX += 1))
while [ "${1::1}" = - ];do
case "$1" in
-n)_crea=;;
-r)_rdry='-r';;
-s)shift;_vtmp="$1";;
esac;shift
done
printf -v "$_vtmp" '%s' "$_temp"
[ -z "$_crea" ]&&return 0
dryrun $_rdry $"Temporary file" "$_temp"&&return 1
_cen_create_file "$_temp"
}
main(){
if [ "${CEN_NAME:--}" = - ] ;then
CEN_NAME="${BASH_ARGV0##*/}"
CEN_FEATURE_F=1;CEN_FEATURE_Y=1
fi
local _opts=':';PATH=' ' type -t 'options' &>/dev/null&&_opts='options'
while [ "${1::1}" = - ];do
CEN_ARGS=;CEN_ARGOPT=;CEN_ACTION="$1";CEN_ACTARR="$2"
case "$1" in
--*=*)CEN_ARGOPT="${1#*=}";CEN_ACTION="${1%%=*}";;
-[^-]*)CEN_ARGOPT="${1:2}";CEN_ACTION="${1::2}";;
--|---)shift;break;;
esac
$_opts "$CEN_ACTION" "${CEN_ARGOPT:-$2}"
[ -z "$CEN_ARGS" ]&&CEN_ARGS=1&&case "$CEN_ACTION" in
-d|--dry*)CEN_OPT_DRYRUN=1;;
-f|--for*)[ -n "$CEN_FEATURE_F" ]&&CEN_OPT_FORCE=1||CEN_ARGS=0;;
-h|--help)PATH=' ' type -t usage &>/dev/null&&{ usage >&2;quit -s 2;}
quit $"Option '--help' is not implemented";;
-n|--no)[ -n "$CEN_FEATURE_Y" ]&&CEN_YESNO='n'||CEN_ARGS=0;;
-q|--qui*)CEN_VERB=0;;
-v|--ver*)CEN_VERB=2;;
-y|--yes)[ -n "$CEN_FEATURE_Y" ]&&CEN_YESNO='y'||CEN_ARGS=0;;
--embed)optarg - CEN_NAME -t;;
--info)quit -p "mini-bash-lib $CEN_MINI_VERSION; '%s'; %s" "$CEN_VERSION" \
"${CEN_LEGAL:-$"<unknown Author/Licence>"}";;
--mini*);;
--trace)set -x;;
*) CEN_ARGS=
esac
[ "${CEN_ARGS:-0}" -lt 1 ]&&quit -e $"Unknown option:" "$1"
[ "$CEN_ARGS" -gt $# ]&&CEN_ARGS="$#";shift "$CEN_ARGS"
done
CEN_ACTARR=;CEN_ARGOPT=;CEN_ACTION=;$_opts
PATH=' ' type -t run &>/dev/null||return 2;run "$@"
}
optarg(){
local _name="${2:--}" _aarr="$CEN_ACTARR"
[ "$_name" = - ]&&_name="CEN_OPT_${1^^}"
case "${3:--f}" in
-f)printf -v "$_name" '%s' "${4:-1}";CEN_ARGS=1;;
*)if [ -z "$CEN_ARGOPT" ];then
[ "$_aarr" != - ]&&[ -z "$_aarr" -o "${_aarr::1}" = '-' ] &&
quit -e $"Missing option value:" "--$1"
CEN_ARGS=2;CEN_ARGOPT="$_aarr"
else
CEN_ARGS=1
fi
[ "$CEN_ARGOPT" = - ]&&CEN_ARGOPT="${4:--}";printf -v "$_name" '%s' "$CEN_ARGOPT"
esac
}
quit(){
local _opts=() _term
while [ "${1::1}" = - ];do
case "$1" in
-)break;;
--)shift;break;;
-s)shift;CEN_EXIT="$1";;
-e)_term=$"Terminated after error";CEN_EXIT=1;_opts+=('-e');;
-t|-u)_term=$"Terminated";CEN_EXIT=4;;
*)_opts+=("$1");;
esac;shift
done
type -t "$CEN_HOOK_QUIT" &>/dev/null&&"$CEN_HOOK_QUIT" "$@"
if [ -n "$_term" ];then
if [ $# = 0 ];then set -- "$_term"
elif [ "$*" = - ];then set --
elif [ "$1" = - ];then set -- "$_term""${2:+:}" "${@:2}"
fi
fi
[ -n "$*" ]&&message "${_opts[@]}" "$@"
[ "$CEN_TMP_INDX" != 0 -a -n "$CEN_TMP_BASE" ]&&system -q -r -- rm -f "$CEN_TMP_BASE"*
trace -a -c $"Script exits" "STATUS=$CEN_EXIT";exit "$CEN_EXIT"
}
usagecat(){
local _larr _labl _line;readarray -t -u 0 _larr
for _line in "${_larr[@]}";do
[ "$1" = '-l' ]&&{ printf '%s\n' "$_line";continue;}
case "$_line" in
[a-zA-z]*:*) _labl="${_line%%:*}:";_line="${_line#*:}";;
*)_labl=;;
esac
_line="${_line#"${_line%%[![:space:]]*}"}"
printf '%-11s%s\n' "$_labl" "${_line//°/ }"
done
}
command_not_found_handle(){
set +xeE;exec 1>&$CEN_STDOUT 2>&$CEN_STDERR
message -l $"***ABORT***" $"Command not found:" "$1"
kill -42 $$
}
trap 'trap 42; quit -s 127' 42
}
if PATH=' ' type -t run &>/dev/null;then
main "$@";quit
fi
elif [ -n "$CEN_STAGE" ];then
run "$@"
else
main "$@";quit
fi
### mini-bash-lib end ###

